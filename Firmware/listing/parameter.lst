C51 COMPILER V7.50   PARAMETER                                                             04/03/2016 16:41:40 PAGE 1   


C51 COMPILER V7.50, COMPILATION OF MODULE PARAMETER
OBJECT MODULE PLACED IN .\output\parameter.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE source\parameter.c LARGE BROWSE INCDIR(.\include\) DEBUG OBJECTEXTEND PRINT
                    -(.\listing\parameter.lst) OBJECT(.\output\parameter.obj)

line level    source

   1          /***************************************************************************/
   2          // 程序：15型座垫机控制系统
   3          // 模块：参数函数
   4          // 文件：parameter.c
   5          // 作者：卜晓D
   6          // 版本：V0.01
   7          // 日期：2016年4月3日
   8          // 功能：主函数
   9          // 芯片：STC12C5A60S2
  10          // 编译：Keil uVision3 V3.90
  11          /***************************************************************************/
  12          
  13          #include <parameter.h>
  14          #include <eeprom.h>
  15          #include <basefunc.h>
  16          
  17          /***************************************************************************/
  18          // 参数定义     
  19          /***************************************************************************/
  20          
  21          unsigned char runMode; //运行模式 0：停止 1：运行
  22          
  23          unsigned char motor1Position; //电机1当前位置 0~39
  24          unsigned char motor2Position; //电机2当前位置 0~39
  25          
  26          unsigned char motor1Direction; //电机1运行方向
  27          unsigned char motor2Direction; //电机2运行方向
  28          
  29          unsigned char isStartPosition1; //电机1是否在初始位置标志位
  30          unsigned char isStartPosition2; //电机2是否在初始位置标志位
  31          
  32          unsigned long stepTotalPWMs; //单步总脉冲数
  33          unsigned long stepRemainPWMs; //单步剩余脉冲数
  34          unsigned long totalPWMs; //运行总脉冲数
  35          
  36          unsigned int motorRotationAngle[6][40]; //电机旋转角 6组数据，每组40个
  37          unsigned int currentStage; //当前运行数据组0~5
  38          
  39          unsigned char refreshDisplay; //刷新屏幕标志位 0 不刷新 1刷新
  40          
  41          
  42          
  43          /***************************************************************************/
  44          // 读取参数
  45          // 参数：无
  46          // 返回值：0失败 1成功  
  47          /***************************************************************************/
  48          unsigned char parameter_read()
  49          {
  50   1              
  51   1              unsigned char result = 0;
  52   1              delay_ms(10); 
  53   1              if(IapReadByte(IAP_ADDRESS+200) == 0xEE)
  54   1              {       
C51 COMPILER V7.50   PARAMETER                                                             04/03/2016 16:41:40 PAGE 2   

  55   2                      /*
  56   2                      pulseSettingNum = ((IapReadByte(IAP_ADDRESS+0) << 8) | IapReadByte(IAP_ADDRESS+1));
  57   2                      //pulseSettingFreq = ((IapReadByte(IAP_ADDRESS+2) << 8) | IapReadByte(IAP_ADDRESS+3));
  58   2                      //motorStepAngle = ((IapReadByte(IAP_ADDRESS+4) << 8) | IapReadByte(IAP_ADDRESS+5));
  59   2                      screwPitch = ((IapReadByte(IAP_ADDRESS+6) << 8) | IapReadByte(IAP_ADDRESS+7));
  60   2                      motorReducGearRatio = ((IapReadByte(IAP_ADDRESS+8) << 8) | IapReadByte(IAP_ADDRESS+9));
  61   2                      ballScrew = ((IapReadByte(IAP_ADDRESS+10) << 8) | IapReadByte(IAP_ADDRESS+11));
  62   2                      motorRotationAngle = ((IapReadByte(IAP_ADDRESS+12) << 8) | IapReadByte(IAP_ADDRESS+13));
  63   2                      */
  64   2                      result = 1;
  65   2              }
  66   1              return result;
  67   1      }
  68          
  69          /***************************************************************************/
  70          // 参数初始化函数
  71          // 参数：无
  72          // 返回值：无   
  73          /***************************************************************************/
  74          void parameter_init()
  75          {
  76   1              //currentPosition = 1; //当前位置 1~20
  77   1              if(!parameter_read())
  78   1              {
  79   2                      /*
  80   2                      pulseSettingNum = 400; //脉冲个数
  81   2                      pulseSettingFreq = 400; //脉冲频率
  82   2                      motorStepAngle = 180; //电机步进角
  83   2                      screwPitch = 200; //丝杆丝距
  84   2                      motorReducGearRatio = 100; //电机减速比
  85   2                      ballScrew = 200; //丝杆导程
  86   2                      motorRotationAngle = 36000; //电机旋转角
  87   2                      */
  88   2              }
  89   1              /*
  90   1              isStartPosition = 0; //初始位置
  91   1              refreshDisplay = 1;
  92   1              initFlag = 0;
  93   1              */
  94   1      }
  95          
  96          /***************************************************************************/
  97          // 参数保存到eeprom
  98          // 参数：无
  99          // 返回值：0失败 1成功  
 100          /***************************************************************************/
 101          unsigned char parameter_save()
 102          {
 103   1              
 104   1              unsigned char result = 1;
 105   1          delay_ms(10);                      //Delay
 106   1              IapEraseSector(IAP_ADDRESS); //擦除EEPROM
 107   1              /*
 108   1              IapProgramByte(IAP_ADDRESS+0, (BYTE)(pulseSettingNum>>8));
 109   1              IapProgramByte(IAP_ADDRESS+1, (BYTE)pulseSettingNum);
 110   1              IapProgramByte(IAP_ADDRESS+2, (BYTE)(pulseSettingFreq>>8));
 111   1              IapProgramByte(IAP_ADDRESS+3, (BYTE)pulseSettingFreq);
 112   1              IapProgramByte(IAP_ADDRESS+4, (BYTE)(motorStepAngle>>8));
 113   1              IapProgramByte(IAP_ADDRESS+5, (BYTE)motorStepAngle);
 114   1              IapProgramByte(IAP_ADDRESS+6, (BYTE)(screwPitch>>8));
 115   1              IapProgramByte(IAP_ADDRESS+7, (BYTE)screwPitch);
 116   1              IapProgramByte(IAP_ADDRESS+8, (BYTE)(motorReducGearRatio>>8));
C51 COMPILER V7.50   PARAMETER                                                             04/03/2016 16:41:40 PAGE 3   

 117   1              IapProgramByte(IAP_ADDRESS+9, (BYTE)motorReducGearRatio);
 118   1              IapProgramByte(IAP_ADDRESS+10, (BYTE)(ballScrew>>8));
 119   1              IapProgramByte(IAP_ADDRESS+11, (BYTE)ballScrew);
 120   1              IapProgramByte(IAP_ADDRESS+12, (BYTE)(motorRotationAngle>>8));
 121   1              IapProgramByte(IAP_ADDRESS+13, (BYTE)motorRotationAngle);
 122   1              IapProgramByte(IAP_ADDRESS+200, 0xEE); //写入标志位
 123   1              refreshDisplay = 0;
 124   1              */
 125   1              return result;
 126   1      }
 127          
 128          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =     62    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    502       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
