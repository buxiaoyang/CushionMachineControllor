C51 COMPILER V7.50   PARAMETER                                                             04/04/2016 21:01:16 PAGE 1   


C51 COMPILER V7.50, COMPILATION OF MODULE PARAMETER
OBJECT MODULE PLACED IN .\output\parameter.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE source\parameter.c LARGE BROWSE INCDIR(.\include\) DEBUG OBJECTEXTEND PRINT
                    -(.\listing\parameter.lst) OBJECT(.\output\parameter.obj)

line level    source

   1          /***************************************************************************/
   2          // 程序：15型座垫机控制系统
   3          // 模块：参数函数
   4          // 文件：parameter.c
   5          // 作者：卜晓D
   6          // 版本：V0.01
   7          // 日期：2016年4月3日
   8          // 功能：主函数
   9          // 芯片：STC12C5A60S2
  10          // 编译：Keil uVision3 V3.90
  11          /***************************************************************************/
  12          
  13          #include <parameter.h>
  14          #include <eeprom.h>
  15          #include <basefunc.h>
  16          
  17          /***************************************************************************/
  18          // 参数定义
  19          /***************************************************************************/
  20          
  21          enum RunMode runMode; //运行模式 0：停止 1：运行
  22          struct Motor motor1, motor2; //电机
  23          unsigned int motorRotationAngle[6][40]; //电机旋转角 6组数据，每组40个
  24          unsigned char motorCurrentRatationGroup; //当前设置旋转角组
  25          enum DisplayMode displayMode; //刷新屏幕标志位 0 不刷新
  26          
  27          /***************************************************************************/
  28          // 读取参数
  29          // 参数：无
  30          // 返回值：0失败 1成功  
  31          /***************************************************************************/
  32          unsigned char parameter_read()
  33          {
  34   1              WORD result = 0,i,j,address;
  35   1              Delay(10); 
  36   1              if(IapReadByte(IAP_ADDRESS+511) == 0xEE)
  37   1              {       
  38   2                      for(i=0; i < 6; i++)
  39   2                      {
  40   3                              for(j=0; j < 40; j++)
  41   3                              {
  42   4                                      address = i * 80 + (j<<1);
  43   4                                      motorRotationAngle[i][j] = (WORD)((IapReadByte(IAP_ADDRESS + address) << 8) | IapReadByte(IAP_ADDRESS 
             -+ address + 1));
  44   4                              }
  45   3                              
  46   3                      }
  47   2                      result = 1;
  48   2              }
  49   1              return result;
  50   1      }
  51          
  52          /***************************************************************************/
  53          // 参数初始化函数
C51 COMPILER V7.50   PARAMETER                                                             04/04/2016 21:01:16 PAGE 2   

  54          // 参数：无
  55          // 返回值：无   
  56          /***************************************************************************/
  57          void parameter_init()
  58          {       
  59   1              WORD i,j;
  60   1              if(!parameter_read())
  61   1              {
  62   2                      for(i=0; i < 6; i++)
  63   2                      {
  64   3                              for(j=0; j < 40; j++)
  65   3                              {
  66   4                                      motorRotationAngle[i][j] = 0;
  67   4                              }
  68   3                      }       
  69   2              }
  70   1      
  71   1              //电机参数初始化
  72   1              motor1.position = 0;
  73   1              motor1.status = MOTOR_STOP;
  74   1              motor1.isStartPosition = 1;
  75   1              motor1.stepPWMs = 0;
  76   1              motor1.stepPassPWMs = 0;
  77   1              motor1.totalPWMs = 0;
  78   1              motor1.currentStage = 0;
  79   1      
  80   1              motor2.position = 0;
  81   1              motor2.status = MOTOR_STOP;
  82   1              motor2.isStartPosition = 1;
  83   1              motor2.stepPWMs = 0;
  84   1              motor2.stepPassPWMs = 0;
  85   1              motor2.totalPWMs = 0;
  86   1              motor2.currentStage = 0;
  87   1      }
  88          
  89          /***************************************************************************/
  90          // 参数保存到eeprom
  91          // 参数：无
  92          // 返回值：0失败 1成功  
  93          /***************************************************************************/
  94          unsigned char parameter_save()
  95          {
  96   1              WORD result = 1,i,j,address;
  97   1          Delay(10);                     //Delay
  98   1              IapEraseSector(IAP_ADDRESS); //擦除EEPROM
  99   1              Delay(10);  
 100   1              //写入参数
 101   1              for(i=0; i < 6; i++)
 102   1              {
 103   2                      for(j=0; j < 40; j++)
 104   2                      {
 105   3                              address = i * 80 + (j<<1);
 106   3                              IapProgramByte(IAP_ADDRESS + address, (BYTE)(motorRotationAngle[i][j]>>8));
 107   3                              IapProgramByte(IAP_ADDRESS + address+1, (BYTE)(motorRotationAngle[i][j]));
 108   3                      }
 109   2              }
 110   1              IapProgramByte(IAP_ADDRESS+511, 0xEE); //写入标志位
 111   1              Delay(10);
 112   1              //测试写入
 113   1              for(i=0; i < 6; i++)
 114   1              {
 115   2                      for(j=0; j < 40; j++)
C51 COMPILER V7.50   PARAMETER                                                             04/04/2016 21:01:16 PAGE 3   

 116   2                      {
 117   3                              address = i * 80 + (j<<1);
 118   3                              if(motorRotationAngle[i][j] != (WORD)((IapReadByte(IAP_ADDRESS + address) << 8) | IapReadByte(IAP_ADDRE
             -SS + address + 1)))
 119   3                              {
 120   4                                      result = 0;
 121   4                              }
 122   3                      }
 123   2                      
 124   2              }
 125   1              return result;
 126   1      }
 127          
 128          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    929    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    515      16
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
